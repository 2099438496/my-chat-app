<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title>WebChat Ultimate</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <style>
        :root { --primary-color: #007AFF; --self-bg: #95ec69; --bg-color: #f2f2f2; --sidebar-bg: #2e3b4e; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: -apple-system, sans-serif; height: 100dvh; display: flex; background-color: var(--bg-color); overflow: hidden; }

        /* === 1. ç™»å½•å±‚æ ·å¼ === */
        #auth-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        #auth-box { background: white; padding: 30px; border-radius: 16px; width: 320px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; }
        .auth-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .auth-btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-secondary { background: transparent; color: var(--primary-color); margin-top: 10px; }
        #auth-error { color: red; font-size: 14px; margin-top: 10px; min-height: 20px; }

        /* === 2. ä¸»ç•Œé¢ç»“æ„ === */
        #main-app { display: none; width: 100%; height: 100%; display: flex; } /* ç™»å½•åæ˜¾ç¤º */
        #sidebar { width: 260px; background-color: var(--sidebar-bg); color: #ecf0f1; display: flex; flex-direction: column; transition: 0.3s; z-index: 2; }
        #main { flex: 1; display: flex; flex-direction: column; background: #f5f5f5; width: 100%; position: relative; }

        /* ä¾§è¾¹æ  */
        .sidebar-header { padding: 20px; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.1); cursor: pointer; }
        #user-list { list-style: none; padding: 10px; margin: 0; overflow-y: auto; flex: 1; }
        .user-item { padding: 8px; display: flex; align-items: center; font-size: 0.9rem; }
        .user-avatar-sm { width: 28px; height: 28px; border-radius: 50%; margin-right: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; }

        /* èŠå¤©å¤´éƒ¨ */
        .chat-header { height: 50px; background: white; border-bottom: 1px solid #ddd; display: flex; align-items: center; padding: 0 15px; justify-content: space-between; flex-shrink: 0; }
        .menu-btn { display: none; font-size: 1.5rem; margin-right: 15px; color: #555; cursor: pointer; }

        /* æ¶ˆæ¯åˆ—è¡¨ */
        #messages { flex: 1; list-style: none; margin: 0; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
        .message-row { display: flex; align-items: flex-end; max-width: 85%; }
        .message-row.right { align-self: flex-end; flex-direction: row-reverse; }
        .message-row.left { align-self: flex-start; }
        
        .avatar { width: 36px; height: 36px; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; flex-shrink: 0; font-size: 14px; }
        
        .bubble-container { margin: 0 10px; display: flex; flex-direction: column; }
        .bubble-meta { font-size: 12px; color: #999; margin-bottom: 3px; }
        .right .bubble-meta { text-align: right; }

        .bubble { padding: 10px 14px; border-radius: 8px; font-size: 15px; line-height: 1.4; word-break: break-all; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1); background: white; }
        .right .bubble { background: var(--self-bg); }
        .bubble img { max-width: 100%; max-height: 200px; border-radius: 4px; display: block; cursor: pointer; }
        .system-message { align-self: center; background: rgba(0,0,0,0.1); padding: 3px 10px; border-radius: 20px; font-size: 12px; color: #666; }

        /* åº•éƒ¨å·¥å…·æ  */
        #typing-bar { height: 20px; padding: 0 15px; font-size: 12px; color: #999; font-style: italic; opacity: 0; transition: 0.3s; flex-shrink: 0; }
        #input-area { background: #f9f9f9; padding: 8px 10px; padding-bottom: calc(8px + env(safe-area-inset-bottom)); border-top: 1px solid #ddd; display: flex; gap: 8px; align-items: center; flex-shrink: 0; position: relative; }
        
        .tool-btn { font-size: 1.4rem; cursor: pointer; background: none; border: none; padding: 0 5px; color: #666; }
        #input { flex: 1; border: 1px solid #ddd; padding: 9px 12px; border-radius: 4px; font-size: 16px; background: white; }
        .send-btn { background: var(--primary-color); color: white; border: none; padding: 0 15px; height: 38px; border-radius: 4px; font-weight: bold; cursor: pointer; }

        /* === 3. è¡¨æƒ…é¢æ¿ === */
        #emoji-picker { position: absolute; bottom: 60px; left: 10px; background: white; border: 1px solid #ddd; border-radius: 8px; padding: 10px; display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: none; z-index: 10; max-width: 300px; }
        #emoji-picker.show { display: grid; }
        .emoji-item { font-size: 1.4rem; cursor: pointer; text-align: center; padding: 5px; }
        .emoji-item:hover { background: #eee; border-radius: 4px; }

        /* === 4. æ›´æ–°æ—¥å¿—æ¨¡æ€æ¡† === */
        #modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: none; align-items: center; justify-content: center; }
        #log-modal { background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; max-height: 70vh; overflow-y: auto; }
        .log-entry { border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
        .log-ver { font-weight: bold; color: var(--primary-color); display: flex; justify-content: space-between; }
        .log-date { font-size: 0.8rem; color: #999; }
        .log-list { margin: 5px 0 0 20px; padding: 0; font-size: 0.9rem; color: #333; }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 700px) {
            #sidebar { position: absolute; height: 100%; transform: translateX(-100%); width: 75%; box-shadow: 2px 0 10px rgba(0,0,0,0.2); }
            #sidebar.open { transform: translateX(0); }
            .menu-btn { display: block; }
        }
    </style>
</head>
<body>

    <div id="modal-overlay" onclick="toggleLog()">
        <div id="log-modal" onclick="event.stopPropagation()">
            <h3 style="margin-top:0;">ç³»ç»Ÿæ›´æ–°æ—¥å¿— ğŸš€</h3>
            <div id="log-content"></div>
            <button onclick="toggleLog()" style="width:100%; padding:10px; background:#eee; border:none; border-radius:6px; margin-top:10px;">å…³ é—­</button>
        </div>
    </div>

    <div id="auth-overlay">
        <div id="auth-box">
            <h2 id="auth-title">æ¬¢è¿å›æ¥</h2>
            <input id="auth-user" class="auth-input" placeholder="è´¦å·" autocomplete="off">
            <input id="auth-pass" class="auth-input" type="password" placeholder="å¯†ç ">
            <div id="auth-error"></div>
            <button class="auth-btn btn-primary" onclick="doLogin()">ç™» å½•</button>
            <button class="auth-btn btn-secondary" onclick="switchMode()">æ²¡æœ‰è´¦å·ï¼Ÿå»æ³¨å†Œ</button>
        </div>
    </div>

    <div id="main-app">
        <div id="sidebar">
            <div class="sidebar-header" onclick="toggleLog()">
                WebChat V2.2
                <div style="font-size:12px; color:#aaa; font-weight:normal; margin-top:5px;">ç‚¹å‡»æŸ¥çœ‹æ›´æ–°æ—¥å¿—</div>
            </div>
            <ul id="user-list"></ul>
        </div>

        <div id="main">
            <div class="chat-header">
                <div style="display:flex; align-items:center;">
                    <div class="menu-btn" onclick="toggleSidebar()">â˜°</div>
                    <span id="header-title">èŠå¤©å®¤</span>
                </div>
                <button onclick="doLogout()" style="background:#e74c3c; color:white; border:none; padding:5px 10px; border-radius:4px; font-size:12px;">é€€å‡º</button>
            </div>

            <ul id="messages"></ul>
            <div id="typing-bar"></div>

            <div id="emoji-picker"></div>

            <form id="input-area">
                <input type="file" id="file-input" accept="image/*" style="display: none;" />
                
                <button type="button" class="tool-btn" onclick="document.getElementById('file-input').click()">ğŸ–¼ï¸</button>
                <button type="button" class="tool-btn" onclick="toggleEmoji()">ğŸ˜€</button>

                <input id="input" autocomplete="off" placeholder="å‘æ¶ˆæ¯..." />
                <button class="send-btn">å‘é€</button>
            </form>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();
        var myName = "";
        var isRegister = false;

        // --- é…ç½®: æ›´æ–°æ—¥å¿— ---
        const logs = [
            { v: "V2.2", d: "2024-02-06", i: ["æ–°å¢ï¼šè´¦æˆ·ç™»å½•/æ³¨å†Œç³»ç»Ÿ", "ä¼˜åŒ–ï¼šåˆå¹¶æ‰€æœ‰åŠŸèƒ½åˆ°ç¨³å®šç‰ˆ"] },
            { v: "V2.0", d: "2024-02-06", i: ["æ–°å¢ï¼šå›¾ç‰‡å‘é€ (æ”¯æŒç²˜è´´/ä¸Šä¼ )", "æ–°å¢ï¼šè¡¨æƒ…åŒ…é¢æ¿"] },
            { v: "V1.0", d: "2024-02-05", i: ["åŸºç¡€èŠå¤©åŠŸèƒ½", "åœ¨çº¿åˆ—è¡¨", "æ‰‹æœºé€‚é…"] }
        ];

        // --- 1. ç™»å½•/æ³¨å†Œé€»è¾‘ ---
        window.onload = () => {
            const u = localStorage.getItem('chatUser');
            if(u) document.getElementById('auth-user').value = u;
            renderLogs(); // æ¸²æŸ“æ—¥å¿—
        };

        function switchMode() {
            isRegister = !isRegister;
            document.getElementById('auth-title').textContent = isRegister ? "æ³¨å†Œæ–°è´¦å·" : "æ¬¢è¿å›æ¥";
            document.querySelector('.btn-primary').textContent = isRegister ? "æ³¨ å†Œ" : "ç™» å½•";
            document.querySelector('.btn-secondary').textContent = isRegister ? "å»ç™»å½•" : "å»æ³¨å†Œ";
            document.getElementById('auth-error').textContent = "";
        }

        function doLogin() {
            const u = document.getElementById('auth-user').value.trim();
            const p = document.getElementById('auth-pass').value.trim();
            if(!u || !p) return showErr("è¯·è¾“å…¥è´¦å·å’Œå¯†ç ");
            socket.emit(isRegister ? 'register' : 'login', { username: u, password: p });
        }

        function doLogout() {
            localStorage.removeItem('chatUser');
            location.reload();
        }

        function showErr(msg) { document.getElementById('auth-error').textContent = msg; }

        socket.on('register_response', res => {
            if(res.success) { alert(res.msg); switchMode(); } else showErr(res.msg);
        });

        socket.on('login_response', res => {
            if(res.success) {
                myName = res.username;
                localStorage.setItem('chatUser', myName);
                document.getElementById('auth-overlay').style.display = 'none';
                document.getElementById('main-app').style.display = 'flex';
                document.getElementById('header-title').textContent = `èŠå¤©å®¤ (${myName})`;
            } else showErr(res.msg);
        });

        // --- 2. èŠå¤© & å›¾ç‰‡é€»è¾‘ ---
        const messages = document.getElementById('messages');
        const input = document.getElementById('input');
        
        document.getElementById('input-area').addEventListener('submit', (e) => {
            e.preventDefault();
            if(input.value.trim()) {
                socket.emit('chat message', { msg: input.value, type: 'text' });
                socket.emit('stop typing');
                input.value = '';
            }
        });

        // å›¾ç‰‡ä¸Šä¼ 
        document.getElementById('file-input').addEventListener('change', function() {
            if(this.files[0]) sendImg(this.files[0]);
            this.value = '';
        });

        // å›¾ç‰‡ç²˜è´´
        input.addEventListener('paste', (e) => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for(let item of items) {
                if(item.kind === 'file' && item.type.startsWith('image/')) {
                    sendImg(item.getAsFile());
                }
            }
        });

        function sendImg(file) {
            if(file.size > 5*1024*1024) return alert("å›¾ç‰‡å¤ªå¤§äº†(>5MB)");
            const reader = new FileReader();
            reader.onload = (e) => socket.emit('chat message', { msg: e.target.result, type: 'image' });
            reader.readAsDataURL(file);
        }

        // --- 3. æ¶ˆæ¯æ¸²æŸ“ ---
        socket.on('chat message', (data) => {
            const li = document.createElement('li');
            const isMe = data.user === myName;
            li.className = `message-row ${isMe ? 'right' : 'left'}`;
            const color = stringToColor(data.user);
            
            const content = data.type === 'image' 
                ? `<img src="${data.text}" onclick="window.open(this.src)">` 
                : data.text;

            li.innerHTML = `
                <div class="avatar" style="background:${color}">${data.user[0].toUpperCase()}</div>
                <div class="bubble-container">
                    <div class="bubble-meta">${!isMe ? data.user : ''} ${data.time}</div>
                    <div class="bubble">${content}</div>
                </div>
            `;
            messages.appendChild(li);
            requestAnimationFrame(() => messages.scrollTop = messages.scrollHeight);
        });

        socket.on('system', msg => {
            const li = document.createElement('li');
            li.className = 'system-message';
            li.textContent = msg;
            messages.appendChild(li);
            messages.scrollTop = messages.scrollHeight;
        });

        // --- 4. è¡¨æƒ… & æ—¥å¿— & æ‚é¡¹ ---
        const emojis = ["ğŸ˜€","ğŸ˜‚","ğŸ¤£","ğŸ˜","ğŸ¥°","ğŸ˜","ğŸ˜­","ğŸ˜¡","ğŸ‘","ğŸ‘","ğŸ‰","ğŸ”¥","â¤ï¸","ğŸ’©","ğŸ‘»","ğŸ±","ğŸ¶","ğŸ™ˆ"];
        const picker = document.getElementById('emoji-picker');
        emojis.forEach(e => {
            const span = document.createElement('span');
            span.className = 'emoji-item';
            span.textContent = e;
            span.onclick = () => { input.value += e; input.focus(); picker.classList.remove('show'); };
            picker.appendChild(span);
        });
        
        function toggleEmoji() { picker.classList.toggle('show'); }
        function toggleLog() { 
            const m = document.getElementById('modal-overlay');
            m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
        }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        
        function renderLogs() {
            const c = document.getElementById('log-content');
            c.innerHTML = logs.map(l => `
                <div class="log-entry">
                    <div class="log-ver"><span>${l.v}</span><span class="log-date">${l.d}</span></div>
                    <ul class="log-list">${l.i.map(i=>`<li>${i}</li>`).join('')}</ul>
                </div>
            `).join('');
        }

        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            let c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            return '#' + "00000".substring(0, 6 - c.length) + c;
        }

        socket.on('update user list', users => {
            document.getElementById('user-list').innerHTML = users.map(u => 
                `<li class="user-item"><div class="user-avatar-sm" style="background:${stringToColor(u)}">${u[0].toUpperCase()}</div>${u}</li>`
            ).join('');
        });

        // è¾“å…¥ç›‘å¬
        let typingTimer;
        input.addEventListener('input', () => {
            socket.emit('typing');
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => socket.emit('stop typing'), 1000);
        });
        socket.on('typing', u => { 
            const bar = document.getElementById('typing-bar');
            bar.textContent = `${u} æ­£åœ¨è¾“å…¥...`; bar.style.opacity = 1;
        });
        socket.on('stop typing', () => document.getElementById('typing-bar').style.opacity = 0);
        
        // ç‚¹å‡»ç©ºç™½å¤„å…³é—­è¡¨æƒ…
        document.addEventListener('click', e => {
            if(!e.target.closest('#emoji-picker') && !e.target.closest('.tool-btn')) picker.classList.remove('show');
        });
    </script>
</body>
</html>