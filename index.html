<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title>WebChat Account Edition</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <style>
        :root { --primary-color: #007AFF; --bg-color: #f2f2f2; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: -apple-system, sans-serif; height: 100dvh; display: flex; background-color: var(--bg-color); overflow: hidden; }

        /* === ç™»å½•ç•Œé¢æ ·å¼ === */
        #auth-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        #auth-box { background: white; padding: 30px; border-radius: 16px; width: 320px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; }
        #auth-box h2 { margin-top: 0; color: #333; }
        .auth-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .auth-btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-secondary { background: transparent; color: var(--primary-color); margin-top: 10px; }
        #auth-error { color: red; font-size: 14px; margin-top: 10px; min-height: 20px; }

        /* === èŠå¤©ç•Œé¢æ ·å¼ (å¤ç”¨ä¹‹å‰çš„) === */
        #main-app { display: none; width: 100%; height: 100%; display: flex; } /* é»˜è®¤éšè—ï¼Œç™»å½•åæ˜¾ç¤º */
        #sidebar { width: 260px; background: #2e3b4e; color: white; display: flex; flex-direction: column; }
        #main { flex: 1; display: flex; flex-direction: column; background: #f5f5f5; width: 100%; }
        
        #messages { flex: 1; list-style: none; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .message-row { display: flex; align-items: flex-end; max-width: 80%; }
        .right { align-self: flex-end; flex-direction: row-reverse; }
        .left { align-self: flex-start; }
        .bubble { padding: 10px 15px; border-radius: 8px; background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); word-break: break-all; }
        .right .bubble { background: #95ec69; }
        .bubble img { max-width: 150px; border-radius: 4px; }
        
        #input-area { background: white; padding: 10px; display: flex; gap: 10px; border-top: 1px solid #ddd; padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        #input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 0 15px; background: var(--primary-color); color: white; border: none; border-radius: 4px; }

        @media (max-width: 700px) { 
            #sidebar { display: none; } 
            #main-app { display: none; } /* åˆå§‹éšè— */
        }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div id="auth-box">
            <h2 id="auth-title">æ¬¢è¿å›æ¥ ğŸ‘‹</h2>
            <input id="auth-user" class="auth-input" placeholder="è´¦å· / æ˜µç§°" autocomplete="off">
            <input id="auth-pass" class="auth-input" type="password" placeholder="å¯†ç ">
            <div id="auth-error"></div>
            
            <button class="auth-btn btn-primary" onclick="doLogin()">ç™» å½•</button>
            <button class="auth-btn btn-secondary" onclick="switchMode()">æ²¡æœ‰è´¦å·ï¼Ÿå»æ³¨å†Œ</button>
        </div>
    </div>

    <div id="main-app" style="display: none;"> <div id="sidebar">
            <div style="padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">WebChat åœ¨çº¿åˆ—è¡¨</div>
            <ul id="user-list" style="padding: 10px; list-style: none;"></ul>
        </div>

        <div id="main">
            <div style="height: 50px; background: white; display: flex; align-items: center; padding: 0 20px; border-bottom: 1px solid #ddd;">
                <span id="header-title">èŠå¤©å®¤</span>
                <button onclick="doLogout()" style="margin-left: auto; background: #e74c3c; font-size: 0.8rem;">é€€å‡º</button>
            </div>
            
            <ul id="messages"></ul>

            <form id="input-area">
                <input type="file" id="file-input" accept="image/*" style="display: none;">
                <button type="button" onclick="document.getElementById('file-input').click()" style="background:none; color:#555; font-size:1.2rem;">ğŸ–¼ï¸</button>
                <input id="input" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." autocomplete="off">
                <button>å‘é€</button>
            </form>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();
        var isRegisterMode = false;
        var myName = "";

        // === ç™»å½•/æ³¨å†Œ é€»è¾‘ ===
        
        // 1. æ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰ä¿å­˜çš„ç™»å½•çŠ¶æ€
        window.onload = function() {
            const savedUser = localStorage.getItem('chatUser');
            if (savedUser) {
                document.getElementById('auth-user').value = savedUser;
            }
        };

        function switchMode() {
            isRegisterMode = !isRegisterMode;
            const title = document.getElementById('auth-title');
            const primaryBtn = document.querySelector('.btn-primary');
            const secondaryBtn = document.querySelector('.btn-secondary');
            
            if (isRegisterMode) {
                title.textContent = "åˆ›å»ºæ–°è´¦å· ğŸš€";
                primaryBtn.textContent = "æ³¨ å†Œ";
                primaryBtn.onclick = doRegister;
                secondaryBtn.textContent = "å·²æœ‰è´¦å·ï¼Ÿå»ç™»å½•";
            } else {
                title.textContent = "æ¬¢è¿å›æ¥ ğŸ‘‹";
                primaryBtn.textContent = "ç™» å½•";
                primaryBtn.onclick = doLogin;
                secondaryBtn.textContent = "æ²¡æœ‰è´¦å·ï¼Ÿå»æ³¨å†Œ";
            }
            document.getElementById('auth-error').textContent = "";
        }

        function doRegister() {
            const u = document.getElementById('auth-user').value.trim();
            const p = document.getElementById('auth-pass').value.trim();
            if(!u || !p) return showErr("è´¦å·å¯†ç ä¸èƒ½ä¸ºç©º");
            socket.emit('register', { username: u, password: p });
        }

        function doLogin() {
            const u = document.getElementById('auth-user').value.trim();
            const p = document.getElementById('auth-pass').value.trim();
            if(!u || !p) return showErr("è´¦å·å¯†ç ä¸èƒ½ä¸ºç©º");
            socket.emit('login', { username: u, password: p });
        }

        function doLogout() {
            localStorage.removeItem('chatUser');
            location.reload();
        }

        function showErr(msg) {
            document.getElementById('auth-error').textContent = msg;
        }

        // === Socket åé¦ˆå¤„ç† ===
        
        socket.on('register_response', (res) => {
            if (res.success) {
                alert(res.msg);
                switchMode(); // æ³¨å†ŒæˆåŠŸï¼Œåˆ‡æ¢å›ç™»å½•ç•Œé¢
            } else {
                showErr(res.msg);
            }
        });

        socket.on('login_response', (res) => {
            if (res.success) {
                // ç™»å½•æˆåŠŸï¼
                myName = res.username;
                localStorage.setItem('chatUser', myName); // è®°ä½è´¦å·
                
                // éšè—ç™»å½•æ¡†ï¼Œæ˜¾ç¤ºèŠå¤©ç•Œé¢
                document.getElementById('auth-overlay').style.display = 'none';
                document.getElementById('main-app').style.display = 'flex';
                document.getElementById('header-title').textContent = `èŠå¤©å®¤ (${myName})`;
            } else {
                showErr(res.msg);
            }
        });

        // === èŠå¤©é€»è¾‘ (ç²¾ç®€ç‰ˆ) ===
        
        const messages = document.getElementById('messages');
        const input = document.getElementById('input');

        document.getElementById('input-area').addEventListener('submit', function(e) {
            e.preventDefault();
            if (input.value) {
                socket.emit('chat message', input.value);
                input.value = '';
            }
        });

        // å›¾ç‰‡å¤„ç†
        document.getElementById('file-input').addEventListener('change', function() {
            const file = this.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (e) => socket.emit('chat message', { msg: e.target.result, type: 'image' });
                reader.readAsDataURL(file);
                this.value = '';
            }
        });

        socket.on('chat message', (data) => {
            const li = document.createElement('li');
            li.className = `message-row ${data.user === myName ? 'right' : 'left'}`;
            
            let content = data.type === 'image' 
                ? `<img src="${data.text}" onclick="window.open(this.src)">` 
                : data.text;

            li.innerHTML = `
                <div style="display:flex; flex-direction:column; margin:0 10px;">
                    <span style="font-size:0.7rem; color:#999; margin-bottom:2px;">${data.user}</span>
                    <div class="bubble">${content}</div>
                </div>
            `;
            messages.appendChild(li);
            messages.scrollTop = messages.scrollHeight;
        });
        
        socket.on('update user list', (users) => {
            const ul = document.getElementById('user-list');
            ul.innerHTML = users.map(u => `<li>${u}</li>`).join('');
        });
    </script>
</body>
</html>